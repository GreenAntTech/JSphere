console.log("elementJS:","v1.0.0-preview.229");let idCount=0;const appContext={server:!!globalThis.Deno,client:!globalThis.Deno,documentElement:null,ctx:null};class Feature{featureFlags=[];constructor(flags){this.featureFlags=flags}async flag(obj){for(const prop in obj){let found=!1;const flags=prop.split(",");for(const flag of flags)if(this.featureFlags.includes(flag)||"default"==flag){await obj[prop](),found=!0;break}if(found)break}}}class RenderError extends Error{constructor(message){super(message),this.name="RenderError"}}function processEvent(event){try{let message;try{message=JSON.parse(event.data)}catch(e){return void(e&&console.warn("Received unparsable message:",event.data))}if(!isValidMessage(message))return void console.warn("Invalid message structure:",message);const subject=message.subject,data=message.data;let listenerFound=!1;if(!registeredAllowedOrigins.includes(event.origin))return void console.warn("Message origin not registered:",event.origin);registeredDeviceMessages[subject]&&(listenerFound=!0,window.webkit?window.webkit.messageHandlers.Device.postMessage(event.data):window.Device.postMessage(event.data)),registeredMessages[subject]&&(listenerFound=!0,registeredMessages[subject](data,appContext.ctx));const children=document.documentElement.querySelectorAll("[el-listening]");for(const childElement of children)childElement.is$&&childElement.listensFor$(subject)&&(listenerFound=!0,setTimeout(async()=>{await childElement.onMessageReceived$(subject,data)},0));listenerFound||console.warn(`No message listener was found for the subject '${subject}'`)}catch(e){console.warn("Failed to parse message:",e)}}function isValidMessage(data){return"object"==typeof data&&null!==data&&"subject"in data&&"string"==typeof data.subject}globalThis.addEventListener("message",processEvent,!1),globalThis.addEventListener("popstate",async()=>{setExtendedURL(globalThis.location);for(const routePath in registeredRoutes){const route={path:routePath,handler:registeredRoutes[routePath]},pattern=new globalThis.URLPattern({pathname:route.path});if(pattern.test(extendedURL.href)){await route.handler();break}}},!1);const extendedURL={},feature=new Feature(getFeatureFlags()),registeredAllowedOrigins=[""],registeredCaptions={},registeredComponents={},registeredDependencies={},registeredServerDependencies={},registeredDeviceMessages={},registeredMessages={},registeredRoutes={},resourceCache=new Map;let intersectionObserver;function createComponent(param1,param2){return"string"==typeof param1?(registeredComponents[param1]=param2,param1):(registeredComponents[param1.name]=param1,param1.name)}function deviceSubscribesTo(subject){registeredDeviceMessages[subject]=!0}async function emitMessage(subject,data,target){const docEl=appContext.server?appContext.documentElement:document.documentElement,el=docEl.querySelector("[el-active]");if(el)el.is$&&el.listensFor$(subject)?await el.onMessageReceived$(subject,data):registeredMessages[subject]&&await registeredMessages[subject](data,appContext.ctx);else{if(void 0===target&&(target=window),void 0===data&&(data={}),"function"!=typeof target.postMessage)throw new Error("target: Must be a window object");target.postMessage(JSON.stringify({subject:subject,data:data}))}}function navigateTo(path){if(void 0===path)globalThis.dispatchEvent(new Event("popstate"));else{if(path==globalThis.location.pathname)return;globalThis.history.pushState({},"",path),dispatchEvent(new Event("popstate"))}}async function elementFetch(input,options={headers:[]}){return appContext.server&&(input=`${extendedURL.protocol}//127.0.0.1:${extendedURL.port||"80"}${input}`,options.headers.push(["element-server-request","true"])),await fetch(input,options)}function registerAllowedOrigin(uri){registeredAllowedOrigins.push(uri)}function registerCaptions(name,captions){registeredCaptions[name]=captions}function registerDependencies(dependencies){Object.assign(registeredDependencies,dependencies)}function registerRoute(path,handler){void 0!==path&&"string"==typeof path?"function"==typeof handler?registeredRoutes[path]=handler:console.warn("A valid hanlder must be specified when registering a route:",handler):console.warn("A path must be specified when registering a route:",path)}function registerServerDependencies(dependencies){Object.assign(registeredServerDependencies,dependencies)}function subscribeTo(subject,handler){registeredMessages[subject]=handler}function useCaptions(name){return(value,...args)=>{const captionPack=registeredCaptions[name]||{};let caption=captionPack[value]||value;if(args&&args.length>0)for(let i=0;i<args.length;i++)caption=caption.replaceAll("{"+(i+1)+"}",args[i]);return caption}}function observe(objectToObserve,name,config){const observablesCache=new WeakMap,watchList={};let activeCompute=null;function objectAccessor(path){return{get(target,key,receiver){if("__proxy__"===key)return!0;const value=Reflect.get(target,key,receiver);if(activeCompute&&activeCompute.deps.add({path:path}),Array.isArray(value)&&!value.__proxy__){const proxiedValue=new Proxy(value,arrayAccessor(`${path}.${key}`,receiver,key));return Reflect.set(target,key,proxiedValue,receiver),proxiedValue}if("object"==typeof value&&null!==value&&!value.__proxy__){const proxiedValue=new Proxy(value,objectAccessor(`${path}.${key}`));return Reflect.set(target,key,proxiedValue,receiver),proxiedValue}return value},set(target,key,value,receiver){if(value&&value.__proxy__)return!0;const oldValue=receiver[key];if(deepEqual(value,oldValue))return!0;const result=Reflect.set(target,key,value,receiver);if(result){const rootState=path.split(".")[0];let listeners=watchList[`${path}.${key}`];listeners&&listeners.forEach(listener=>listener(receiver,key,oldValue)),listeners=watchList[`${path}`],listeners&&listeners.forEach(listener=>listener(receiver,key,oldValue)),path!=rootState&&(listeners=watchList[rootState],listeners&&listeners.forEach(listener=>listener(receiver,key,oldValue)))}return result}}}function arrayAccessor(path,parentTarget,parentKey){return{get(target,key,receiver){if("__proxy__"===key)return!0;const mutatingMethods=["push","pop","shift","unshift","splice","replace"];if(mutatingMethods.includes(key))return activeCompute&&activeCompute.deps.add({path:path}),function(...args){let result,oldValue;"replace"===key?(oldValue=target[args[0]],result=target[args[0]]=args[1]):result=target[key].apply(target,args);const rootState=path.split(".")[0],parentPath=path.substring(0,path.lastIndexOf("."));let listeners=watchList[path];return listeners&&listeners.forEach(listener=>listener(parentTarget,parentKey,oldValue)),listeners=watchList[parentPath],listeners&&listeners.forEach(listener=>listener(parentTarget,parentKey,oldValue)),parentPath!=rootState&&(listeners=watchList[rootState],listeners&&listeners.forEach(listener=>listener(parentTarget,parentKey,oldValue))),result};activeCompute&&activeCompute.deps.add({path:path});const value=Reflect.get(target,key,receiver);if(Array.isArray(value)&&!value.__proxy__){const proxiedValue=new Proxy(value,arrayAccessor(`${path}.${key}`,receiver,key));return Reflect.set(target,key,proxiedValue,receiver),proxiedValue}if("object"==typeof value&&null!==value&&!value.__proxy__){const proxiedValue=new Proxy(value,objectAccessor(`${path}.${key}`));return Reflect.set(target,key,proxiedValue,receiver),proxiedValue}return value},set(target,key,value,receiver){if(value&&value.__proxy__)return!0;const oldValue=receiver[key];if(deepEqual(value,oldValue))return!0;const result=Reflect.set(target,key,value,receiver);if(result){const rootState=path.split(".")[0],parentPath=path.substring(0,path.lastIndexOf("."));let listeners=watchList[path];listeners&&listeners.forEach(listener=>listener(parentTarget[parentKey],key,oldValue)),listeners=watchList[parentPath],listeners&&listeners.forEach(listener=>listener(parentTarget[parentKey],key,oldValue)),parentPath!=rootState&&(listeners=watchList[rootState],listeners&&listeners.forEach(listener=>listener(parentTarget[parentKey],key,oldValue)))}return result}}}function makeObservable(obj){if(!obj||"object"!=typeof obj)return console.warn("Only objects can be observed. The following was provided:",obj),obj;if(observablesCache.has(obj))return observablesCache.get(obj);const proxy=new Proxy(obj,objectAccessor(name));return observablesCache.set(obj,proxy),proxy}function watch(root,path,fn,el){let listeners=watchList[path];listeners||(listeners=new Set,watchList[path]=listeners);const listener=(object,key,oldValue)=>{!el||el.parentElement?fn(object,key,oldValue):delete watchList[path]};listeners.add(listener);let obj=root;const arrPath=path.split(".");for(let i=1;i<arrPath.length-1;i++)obj=obj[arrPath[i]];const property=arrPath.pop();return listener(obj,property,obj[property]),()=>{delete watchList[path]}}function compute(fn,el){let cachedValue,dirty=!0;const deps=new Set,recompute=()=>{deps.forEach(({path:path})=>{const listeners=watchList[path];listeners&&listeners.delete(markDirty)}),deps.clear(),activeCompute={deps:deps},cachedValue=fn(),activeCompute=null,dirty=!1,deps.forEach(({path:path})=>{watch(proxy,path,markDirty,el)})};function markDirty(){dirty=!0}return{get value(){return dirty&&recompute(),cachedValue}}}function persistState(){localStorage.setItem(config.key,JSON.stringify(proxy))}function loadState(){const savedState=JSON.parse(localStorage.getItem(config.key)||"{}");savedState&&Object.assign(proxy,savedState)}const proxy=makeObservable(objectToObserve);return config&&config.persist&&config.key&&(loadState(),watch(proxy,"appState",persistState)),[proxy,watch,compute]}function runAt(props){return appContext.server&&props.server?props.server():appContext.client&&props.client?props.client():void 0}async function renderDocument(config,ctx){try{config||(config={}),config.pageState||(config.pageState={}),validateInputs(config,ctx),appContext.ctx=ctx;const appState=observe({},"appState",{persist:!0,key:"elementJS_appState_"+(ctx?ctx.request.url.hostname:globalThis.location.hostname)}),pageState=observe(config.pageState,"pageState");if(appContext.server){setExtendedURL(ctx.request.url);const el=appContext.documentElement=await getDocumentElement(config);el.setAttribute("el-is","document"),el.setAttribute("el-id","document"),initElementAsComponent(el,appState,pageState),await el.init$();const components=el.querySelectorAll("[el-is]");for(const component of components)component.state$&&Object.keys(component.state$).length&&component.setAttribute("el-state",JSON.stringify(component.state$[0]));return el.setAttribute("el-state",JSON.stringify(config.pageState)),el.setAttribute("el-server-rendered","true"),el.setAttribute("el-id-count",idCount.toString()),el}{const el=document.documentElement;return el.setAttribute("el-is","document"),el.setAttribute("el-id","document"),el.hasAttribute("el-server-rendered")?(idCount=parseInt(el.getAttribute("el-id-count")),el.removeAttribute("el-id-count")):el.setAttribute("el-client-rendering","true"),el.hasAttribute("el-state")&&(Object.assign(pageState[0],JSON.parse(el.getAttribute("el-state"))),el.removeAttribute("el-state")),initElementAsComponent(el,appState,pageState),setExtendedURL(globalThis.location),setupIntersectionObserver(),await el.init$(),el}}catch(e){throw console.error("Render error:",e),e}}function validateInputs(config,ctx){if(appContext.server){if(!config||"object"!=typeof config)throw new RenderError("Invalid config object provided");if(!ctx||"object"!=typeof ctx)throw new RenderError("Invalid server context object provided");if(!config.file&&!config.html)throw new RenderError("Either file path or HTML content must be provided")}}async function getDocumentElement(config){let html=config.html;if(!html&&config.file&&(html=await getResource(config.file),!html))throw console.error("Could not create document element - file not found: ",config.file),new RenderError("FileNotFound");return appContext.ctx.parser.parseFromString(html,"text/html").documentElement}function initElementAsComponent(el,appState,pageState){const messageListeners={},hydrateOnComponents=[],stateObject=observe({},"state"),tagNameMap={ul:"li",ol:"li",thead:"tr",tbody:"tr"};let props={},childComponents={},parent,bound=!1,hydrateOnCallback=()=>{};async function onInit(props){el.setAttribute("el-active",""),await el.onInit$(props),el.removeAttribute("el-active"),el.componentState$=1}async function onStyle(props){const theme=props.theme||"",themeId=el.is$+(theme?"_"+theme:"");let css=el.onStyle$(props);if(css)if(css.endsWith(".css")){const path=css;let content;if(path.endsWith(".theme.css")){if(appContext.server?resourceCache.has(path)?(content=resourceCache.get(path),console.log(`Loaded CSS theme from cache: ${path}`)):(content=await getResource(path)||"",void 0!==content&&resourceCache.set(path,content)):content=await getResource(path)||"",content=theme?content.replaceAll("[el]",`[el-is='${el.is$}'][data-theme='${theme}']`):content.replaceAll("[el]",`[el-is='${el.is$}']`),el.setAttribute("data-theme",themeId),el.ownerDocument.getElementById(themeId))return;const tag=el.ownerDocument.createElement("style");tag.setAttribute("id",themeId),tag.textContent=content,el.ownerDocument.head.append(tag)}else{if(el.ownerDocument.head.querySelector(`[href='${path}']`))return;const tag=el.ownerDocument.createElement("link");tag.setAttribute("rel","stylesheet"),tag.setAttribute("href",path),el.ownerDocument.head.append(tag)}}else{if(el.ownerDocument.head.querySelector(`[id="${themeId}"]`))return;css=theme?css.replaceAll("[el]",`[el-is='${el.is$}'][data-theme='${theme}']`):css.replaceAll("[el]",`[el-is='${el.is$}']`);const tag=el.ownerDocument.createElement("style");tag.setAttribute("id",themeId),tag.textContent=css,el.ownerDocument.head.append(tag)}}async function onTemplate(props){if("component"==el.is$)return;let content;const template=el.onTemplate$(props);if(template&&template.startsWith("/")){const url=template;appContext.server?(resourceCache.has(url)?(content=resourceCache.get(url),console.log(`Loaded template from cache: ${url}`)):(content=await getResource(url)||"",void 0!==content&&resourceCache.set(url,content)),el.innerHTML=sanitize(content)):(content=await getResource(url)||"",el.innerHTML=sanitize(content))}else template?(content=template,el.innerHTML=sanitize(content)):""==template?el.innerHTML=template:["HTML","HEAD","BODY"].includes(el.tagName)||(el.innerHTML="");await getDependencies(el),el.initChildren$()}async function onRender(props){await el.onRender$(props);for(const id in el.children$){const child=el.children$[id];0===child.componentState$&&await child.init$()}el.componentState$=2}async function onPostRender(){await getDependencies(el),el.initChildren$()}async function onHydrate(props){if(el.hasAttribute("el-hydrate-on"))el.componentState$=3,el.ownerDocument.documentElement.hydrateOnComponents$.push({component:el,props:props});else{await el.onHydrate$(props);for(const id in el.children$){const child=el.children$[id];2===child.componentState$&&await child.init$()}if(3==el.componentState$){el.removeAttribute("el-hydration-delayed");const components=el.querySelectorAll(":scope > [el-hydration-delayed]");for(const component of components)component.removeAttribute("el-hydration-delayed")}el.componentState$=-1}}async function onReady(props){await el.onReady$(props),el.removeAttribute("el-parent"),removeDataAttributes(el)}function onHydrateOn(state){const hydrateOnComponents=el.ownerDocument.documentElement.hydrateOnComponents$;if(0!=hydrateOnComponents.length){for(const entry of hydrateOnComponents){const component=entry.component,props=entry.props,hydrateOn=component.getAttribute("el-hydrate-on");component.removeAttribute("el-hydrate-on"),component.setAttribute("el-hydration-delayed",state);const components=el.querySelectorAll(":scope [el-component-state]");for(const child of components)child.setAttribute("el-hydration-delayed",state);if("idle"==hydrateOn||hydrateOn.startsWith("idle:")){const time=hydrateOn.startsWith("idle:")?parseInt(hydrateOn.substring(5)):0;time&&(component.hydrateOnCallback$=async()=>{await getDependencies(component),await component.init$(props)},globalThis.requestIdleCallback(component.hydrateOnCallback$,{timeout:time}))}else if("timeout"==hydrateOn||hydrateOn.startsWith("timeout:")){const time=hydrateOn.startsWith("timeout:")?parseInt(hydrateOn.substring(8)):500;component.hydrateOnCallback$=async()=>{await getDependencies(component),await component.init$(props)},setTimeout(component.hydrateOnCallback$,time)}else{if("visible"!=hydrateOn)throw new RenderError(`Invalid el-hydrate-on attribute value: ${hydrateOn}`);component.hydrateOnCallback$=async()=>{await getDependencies(component),await component.init$(props),intersectionObserver.unobserve(component)},intersectionObserver.observe(component)}}hydrateOnComponents.length=0}else{el.removeAttribute("el-component-state");const hydratedComponents=el.querySelectorAll(":scope [el-component-state]");for(const component of hydratedComponents)component.removeAttribute("el-component-state")}}el.init$||Object.defineProperties(el,{define$:{value:obj=>{const componentProps={};for(const prop in obj){if(!prop.endsWith("$"))throw new RenderError(`Invalid property name '${prop}'. Property names must end with a $.`);"function"==typeof obj[prop]?componentProps[prop]={value:obj[prop]}:componentProps[prop]=obj[prop]}Object.defineProperties(el,componentProps)}},init$:{value:async obj=>{const docEl=el.ownerDocument.documentElement;return appContext.server?el.renderAtClient$?el.children$:(props=addPropsFromAttributes(el,obj),addMissingLifecycleMethods(el),await loadDependencies(el.use$(props)),await onInit(props),await onStyle(props),await onTemplate(props),await onRender(props),el.children$):docEl.hasAttribute("el-server-rendered")?(props=addPropsFromAttributes(el,obj),addMissingLifecycleMethods(el),await loadDependencies(el.use$(props)),"document"==el.is$?(await onPostRender(),await onHydrate(props),onHydrateOn("0"),await onReady(props),docEl.removeAttribute("el-server-rendered")):-1===el.componentState$?(el.componentState$=0,await onInit(props),await onStyle(props),await onTemplate(props),await onRender(props),await onHydrate(props),onHydrateOn("2"),await onReady(props)):(await onPostRender(),await onHydrate(props),await onReady(props)),el.children$):docEl.hasAttribute("el-client-rendering")?(props=addPropsFromAttributes(el,obj),addMissingLifecycleMethods(el),await loadDependencies(el.use$(props)),await onInit(props),await onStyle(props),await onTemplate(props),await onRender(props),"document"==el.is$&&(docEl.removeAttribute("el-client-rendering"),docEl.setAttribute("el-client-hydrating","true"),await onHydrate(props),onHydrateOn("1"),await onReady(props),docEl.removeAttribute("el-client-hydrating")),el.children$):docEl.hasAttribute("el-client-hydrating")?(props=addPropsFromAttributes(el,obj),-1===el.componentState$||0===el.componentState$?(el.componentState$=0,addMissingLifecycleMethods(el),await onInit(props),await onStyle(props),await onTemplate(props),await onRender(props),await onHydrate(props),onHydrateOn("1"),await onReady(props)):(await onHydrate(props),onHydrateOn("1"),await onReady(props)),el.children$):"0"==el.getAttribute("el-hydration-delayed")?(props=addPropsFromAttributes(el,obj),2===el.componentState$?(await onPostRender(),await onHydrate(props),await onReady(props)):3===el.componentState$&&(await onHydrate(props),await onReady(props)),el.children$):["1","2"].includes(el.getAttribute("el-hydration-delayed"))?(props=addPropsFromAttributes(el,obj),2===el.componentState$?(await onHydrate(props),await onReady(props)):3===el.componentState$&&(await onHydrate(props),await onReady(props)),el.children$):(props=addPropsFromAttributes(el,obj),-1===el.componentState$&&(el.componentState$=0,addMissingLifecycleMethods(el),await loadDependencies(el.use$(props)),await onInit(props),await onStyle(props),await onTemplate(props),await onRender(props),await onHydrate(props),onHydrateOn("2"),await onReady(props)),0===el.componentState$?(addMissingLifecycleMethods(el),await loadDependencies(el.use$(props)),await onInit(props),await onStyle(props),await onTemplate(props),await onRender(props)):1===el.componentState$?(await onStyle(props),await onTemplate(props),await onRender(props)):2!==el.componentState$&&3!==el.componentState$||(await onHydrate(props),await onReady(props)),el.children$)}},initChildren$:{value:()=>{let children;if(el.children$={},2===el.componentState$)children=el.querySelectorAll(`:scope [el-parent="${el.id$}"]`);else if("document"==el.id$){children=[];const head=el.querySelector("head"),body=el.querySelector("body");if(head)if(head.hasAttribute("el-is"))children.push(head);else{const components=head.querySelectorAll(":scope [el-id]");for(const component of components)children.push(component)}if(body)if(body.hasAttribute("el-is"))children.push(body);else{const components=body.querySelectorAll(":scope [el-id]");for(const component of components)children.push(component)}}else children=el.querySelectorAll(":scope [el-id]");for(const childElement of children){childElement.hasAttribute("id")||childElement.setAttribute("id",`el${++idCount}`),childElement.setAttribute("el-parent",el.getAttribute("el-id")),initElementAsComponent(childElement),childElement.parent$=el;const elId=childElement.id$;2!==childElement.componentState$&&(childElement.componentState$=0),el.children$[elId]=childElement}}},uId$:{get:()=>el.getAttribute("id")},id$:{get:()=>el.getAttribute("el-id")},is$:{get:()=>el.getAttribute("el-is")},bind$:{value:fn=>{if(!bound){const path=props.bind;if(null==path)return;const arrPath=path?path.split("."):[],stateProp=arrPath[0]+"$",watch=el.parent$[stateProp][1],newWatch=(obj,path,fn)=>{watch(obj,path,fn,el)},state=el.parent$[stateProp][0];let obj=state;for(let i=1;i<arrPath.length-1;i++)obj=obj[arrPath[i]];return bound=!0,[obj,newWatch(state,path,fn)]}}},children$:{get:()=>childComponents,set:value=>{childComponents=value}},componentState$:{set:value=>{-1===value?el.removeAttribute("el-component-state"):el.setAttribute("el-component-state",value.toString())},get:()=>{const value=el.getAttribute("el-component-state");return value?parseInt(value):-1}},hidden$:{set:value=>{if("boolean"==typeof value)if(value){let style=el.getAttribute("style");if(style||(style=""),/\bdisplay\s*:\s*none\b/i.test(style))return;style+="; display: none",el.setAttribute("style",style)}else{let style=el.getAttribute("style");style||(style=""),style=style.replace(/\bdisplay\s*:\s*none\s*;?/gi,"").replace(/;;+/g,";").replace(/^\s*;\s*|\s*;\s*$/g,"").trim(),el.setAttribute("style",style)}},get:()=>{let style=el.getAttribute("style");return style||(style=""),style.includes("display: none")}},hydrateOnCallback$:{set:value=>{hydrateOnCallback=value},get:()=>hydrateOnCallback},hydrateOnComponents$:{get:()=>hydrateOnComponents},insert$:{value:async(element,action,elId)=>{void 0===element.tagName&&void 0===tagNameMap[el.tagName.toLowerCase()]?element.tagName="div":element.tagName=tagNameMap[el.tagName.toLowerCase()];const component=el.ownerDocument.createElement(element.tagName);for(const prop in element)"tagName"!=prop&&"props"!=prop&&component.setAttribute(prop,element[prop]);switch(await loadDependencies([element["el-is"]]),initElementAsComponent(component),component.setAttribute("id",`el${++idCount}`),component.parent$=el,component.setAttribute("el-parent",el.id$),el.children$[element["el-id"]]=component,component.componentState$=-1===el.componentState$?-1:0,action){case"prepend":el.prepend(component);break;case"append":el.append(component);break;case"before":el.children$[elId].before(component);break;case"after":el.children$[elId].after(component);break;default:el.append(component)}return-1===el.componentState$&&await component.init$(element.props),component}},on$:{value:(event,...args)=>{const method=props[`on-${event}`];"string"==typeof method?el.addEventListener(event,()=>el.parent$[method](args)):"function"==typeof method&&el.addEventListener(event,()=>method(args))}},onMessageReceived$:{value:async(subject,data)=>{messageListeners[subject]&&await messageListeners[subject](data,appContext.ctx)}},parent$:{set:value=>{parent=value},get:()=>parent||el.ownerDocument.documentElement},remove$:{value:()=>{el.parent$.removeChild(el)}},removeChild$:{value:childElement=>{delete el.children$[childElement.id$],el.removeChild(childElement)}},renderAtClient$:{get:()=>"client"===el.getAttribute("el-render-at")},listensFor$:{value:subject=>!!messageListeners[subject]},subscribeTo$:{value:(subject,handler)=>{messageListeners[subject]=async data=>{await handler(data)},el.setAttribute("el-listening","true")}},appState$:{get:()=>appState||el.ownerDocument.documentElement.appState$},pageState$:{get:()=>pageState||el.ownerDocument.documentElement.pageState$},state$:{get:()=>stateObject},unsubscribeTo$:{value:subject=>{delete messageListeners[subject],0===Object.keys(messageListeners).length&&el.removeAttribute("el-listening")}}});const type=el.getAttribute("el-is")||"component";"component"==type&&el.setAttribute("el-is","component"),registeredComponents[type]?(el.hasAttribute("el-state")&&(Object.assign(stateObject[0],JSON.parse(el.getAttribute("el-state"))),el.removeAttribute("el-state")),registeredComponents[type](el)):console.warn(`The component type '${type}' is not registered.`)}function addPropsFromAttributes(el,props){const attrs={};for(const attr of el.attributes)if(attr.name.startsWith("data-")){const propName=kebabToCamelCase(attr.name.substring(5));attrs[propName]=attr.value||!0}return props=Object.assign(attrs,props)}function removeDataAttributes(el){for(const attr of el.attributes)attr.name.startsWith("data-")&&el.removeAttribute(attr.name)}function kebabToCamelCase(kebabCaseString){return kebabCaseString.replace(/-([a-z])/g,g=>g[1].toUpperCase())}function addMissingLifecycleMethods(el){void 0===el.use$&&(el.use$=()=>[]),void 0===el.onInit$&&(el.onInit$=()=>{}),void 0===el.onStyle$&&(el.onStyle$=()=>{}),void 0===el.onTemplate$&&(el.onTemplate$=()=>{}),void 0===el.onRender$&&(el.onRender$=()=>{}),void 0===el.onHydrate$&&(el.onHydrate$=()=>{}),void 0===el.onReady$&&(el.onReady$=()=>{})}function sanitize(code){const sanitizedCode=code.replaceAll(/\?eTag=[a-zA-Z0-9:]+[\"]/g,'"').replaceAll(/\?eTag=[a-zA-Z0-9:]+[\']/g,"'");return sanitizedCode}function setupIntersectionObserver(){intersectionObserver=new IntersectionObserver(async entries=>{for(const entry of entries)entry.isIntersecting&&await entry.target.hydrateOnCallback$()},{rootMargin:"100px",threshold:0})}function setExtendedURL(url){const searchParams={};url.searchParams?url.searchParams.forEach((value,key)=>searchParams[key]=value):new URLSearchParams(url.search).forEach((value,key)=>searchParams[key]=value),extendedURL.hash=url.hash,extendedURL.host=url.host,extendedURL.hostname=url.hostname,extendedURL.href=url.href,extendedURL.origin=url.origin,extendedURL.pathname=url.pathname,extendedURL.port=url.port,extendedURL.protocol=url.protocol,extendedURL.search=url.search,extendedURL.searchParams=searchParams}async function getDependencies(el){const dependencies=[];let children;["component","document","link","list"].includes(el.getAttribute("el-is"))||dependencies.push(el.getAttribute("el-is")),children=2===el.componentState$?el.querySelectorAll(`:scope [el-parent="${el.id$}"]`):el.querySelectorAll(":scope [el-is]"),children.forEach(component=>{"component"!=component.getAttribute("el-is")&&(appContext.server&&"client"==component.getAttribute("el-render-at")||appContext.client&&"server"==component.getAttribute("el-render-at")||dependencies.push(component.getAttribute("el-is")))}),await loadDependencies(dependencies)}function getFeatureFlags(){if(appContext.client){const featureFlags=globalThis.document.cookie.split("; ").find(row=>row.startsWith("featureFlags="));if(featureFlags)return featureFlags.split("=")[1].split(":")}return[]}async function getResource(path){if(appContext.server){const file=await appContext.ctx.getPackageItem(path);if(file){const content=(new TextDecoder).decode(file.content);return content}}else{const response=await fetch(path);if(200===response.status){const content=await response.text();return content}}}async function importModule(url){try{if(appContext.server){const module=await import(url+`?eTag=${appContext.ctx.cacheDTS}`);return module}{const module=await import(url);return module}}catch(e){throw console.log(e),new RenderError(`Either the requested resource or one of its dependencies was not found: ${url}`)}}async function loadDependencies(dependencies){try{const imports=dependencies.map(dependency=>{if(!["component","document","link","list"].includes(dependency)){let modulePath=registeredDependencies[dependency];if(appContext.server&&(modulePath=registeredServerDependencies[dependency]||modulePath),modulePath)return importModule(modulePath);registeredComponents[dependency]||console.warn(`Dependency '${dependency}' not registered`)}}).filter(value=>Boolean(value));imports.length>0&&await Promise.allSettled(imports)}catch(e){throw console.error("Failed to load dependencies:",e),e}}function deepEqual(a,b){if(a===b)return!0;if(null===a||null===b)return a===b;if(Array.isArray(a)&&Array.isArray(b)){if(a.length!==b.length)return!1;for(let i=0;i<a.length;i++)if(!deepEqual(a[i],b[i]))return!1;return!0}if("object"==typeof a&&"object"==typeof b){const keysA=Object.keys(a),keysB=Object.keys(b);if(keysA.length!==keysB.length)return!1;for(const key of keysA)if(!deepEqual(a[key],b[key]))return!1;return!0}return!1}globalThis.location&&registerAllowedOrigin(globalThis.location.origin),createComponent("document",el=>{el.define$({onRender$:async props=>{for(const id in el.children$){const child=el.children$[id];Array.isArray(child)?child.forEach(async child=>await child.init$(props)):await child.init$(props)}},onHydrate$:async props=>{for(const id in el.children$){const child=el.children$[id];Array.isArray(child)?child.forEach(async child=>await child.init$(props)):await child.init$(props)}}})}),createComponent("component",el=>{el.define$({text$:{set:value=>{el.textContent=value},get:()=>el.textContent}})}),createComponent("link",el=>{let _onclick;el.define$({onRender$:props=>{void 0!==props.value&&(el.text$=props.value),"boolean"==typeof props.hidden&&(el.hidden$=props.hidden),el.disabled$=props.disabled||!1,el.href$=props.href},onHydrate$:props=>{const onclick=props.onclick||(()=>{});"function"==typeof onclick&&(el.removeEventListener("click",_onclick),_onclick=event=>{event.preventDefault(),el.disabled$||!1!==onclick(event)&&(el.href$?navigateTo(el.href$):el.getAttribute("href")&&(globalThis.location.href=el.getAttribute("href")))},el.addEventListener("click",_onclick))},disabled$:{set:value=>{"boolean"==typeof value&&(value?el.setAttribute("disabled",""):el.removeAttribute("disabled"))},get:()=>el.hasAttribute("disabled")},href$:{set:value=>{"string"==typeof value&&(el.setAttribute("data-href",value),el.setAttribute("href",value))},get:()=>el.getAttribute("data-href")},text$:{set:value=>{el.textContent=value},get:()=>el.textContent}})}),createComponent("caption",el=>{const[appState,watchAppState]=el.appState$,[pageState,watchPageState]=el.pageState$,[state]=el.state$;function setCaption(params){const caption=useCaptions(appState.captionPack||pageState.captionPack);if(params)if(Array.isArray(params))el.textContent=caption(el.id$,...params);else try{const paramsArray=JSON.parse(params);el.textContent=caption(el.id$,...paramsArray)}catch(e){el.textContent=caption(el.id$,params)}else el.textContent=caption(el.id$)}el.define$({onRender$:props=>{setCaption(props.params),state.params=props.params},onHydrate$:()=>{watchAppState(appState,"appState.captionPack",()=>{setCaption(state.params)}),watchPageState(pageState,"pageState.captionPack",()=>{setCaption(state.params)})},param$:{set:value=>{setCaption(value),state.params=value}}})}),createComponent("bound-input",el=>{el.define$({onHydrate$:()=>{const[obj]=el.bind$((obj,property)=>{obj[property]&&(el.value=obj[property])});el.addEventListener("input",()=>{obj[el.id$]=el.value})}})}),createComponent("bound-checkbox",el=>{el.define$({onHydrate$:()=>{const[obj]=el.bind$((obj,property)=>{obj[property]&&(el.checked=obj[property])});el.addEventListener("click",()=>{obj[el.id$]=el.checked})}})}),createComponent("bound-content",el=>{el.define$({onHydrate$:()=>{el.bind$((obj,property)=>{obj[property]&&(el.textContent=obj[property])})}})});export{createComponent as createComponent$,deviceSubscribesTo as deviceSubscribesTo$,emitMessage as emitMessage$,extendedURL as url$,feature as feature$,elementFetch as fetch$,useCaptions as useCaptions$,navigateTo as navigateTo$,registerAllowedOrigin as registerAllowedOrigin$,registerCaptions as registerCaptions$,registerDependencies as registerDependencies$,registerServerDependencies as registerServerDependencies$,registerRoute as registerRoute$,renderDocument as renderDocument$,runAt as runAt$,subscribeTo as subscribeTo$};export{observe};